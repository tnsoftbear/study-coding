# ansible-playbook --user root -k --limit bern_vm1 init.yml
---
- name: Bootstrap VM
  hosts: all
  become: true
  tasks:

    - name: Add APT repositories
      ansible.builtin.blockinfile:
        path: /etc/apt/sources.list
        insertafter: EOF
        block: |
          deb http://deb.debian.org/debian/ bookworm main
          deb http://security.debian.org/ bookworm-security main
          deb http://deb.debian.org/debian/ bookworm-updates main

    - name: Remove CD-ROM repository
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        state: absent
        regexp: '^deb cdrom'

    - name: Install packages
      ansible.builtin.apt:
        name:
          - vim
          - sudo
        state: present
        update_cache: true

    - name: Generate password hash
      ansible.builtin.command: "openssl passwd -6 a"
      register: password_hash
      changed_when: password_hash.rc != 0

    - name: Create user 'ansible' and add to 'sudo' group
      ansible.builtin.user:
        name: ansible
        groups: sudo
        append: true
        password: "{{ password_hash.stdout }}"

    - name: Upload SSH public key for ansible user
      ansible.posix.authorized_key:
        user: ansible
        state: present
        key: "{{ lookup('file', '/home/ansible/.ssh/id_rsa.pub') }}"

    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin yes'
        line: 'PermitRootLogin no'

    - name: Restart SSH service
      ansible.builtin.service:
        name: ssh
        state: restarted
